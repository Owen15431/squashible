---

  - name: Sort builder tasks based on OS version
    group_by: >
      key=builder_{{ansible_distribution | lower}}_{{ansible_distribution_major_version}}

  - name: Determine absolute paths for chroot/output
    set_fact: >
      chrootpath={{ansible_env['PWD']}}/{{chrootpath}}
      output={{ansible_env['PWD']}}/{{chrootpath}}

  - name: Set uuid for this ansible run 
    command: uuid
    register: ansible_run_uuid

  - name: Set uuid fact
    set_fact: >
      ansible_run_uuid={{ansible_run_uuid.stdout}}

  - name: Unmount filesystems left over from a failed build
    mount: >
      name={{chrootpath}}/{{item.dest}}
      src={{item.src}}
      fstype={{item.fstype}}
      state=unmounted
    with_items:
      - { fstype: "proc",       src: "none",        dest: "proc" }
      - { fstype: "selinuxfs",  src: "selinuxfs",   dest: "sys/fs/selinux" }

  - name: Clean up the chroot path
    file: >
      dest={{ chrootpath }}
      state={{ item }}
      owner=root
      group=root
      mode=0755
    with_items:
      - absent
      - directory
